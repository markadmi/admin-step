<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>🎛️ لوحة التحكم في الفيديوهات - Ishraq Step</title>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #4caf50, #00bcd4);
      margin: 0;
      padding: 20px;
      color: #333;
      direction: rtl;
    }

    h1 {
      text-align: center;
      color: white;
    }

    .form {
      background: white;
      padding: 15px;
      border-radius: 12px;
      max-width: 500px;
      margin: 20px auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: linear-gradient(90deg, #4caf50, #00bcd4);
      color: white;
      border: none;
      padding: 10px;
      margin-top: 15px;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      opacity: 0.9;
    }

    .sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .section-card {
      background: linear-gradient(135deg, #4caf50, #00eeff);
      color: white;
      border-radius: 14px;
      text-align: center;
      padding: 14px;
      cursor: pointer;
      transition: transform 0.25s ease;
    }

    .section-card:hover {
      transform: scale(1.05);
    }

    .videos-list {
      margin-top: 20px;
    }

    .video-item {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .video-item iframe {
      width: 100%;
      border-radius: 10px;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* 📜 معاينة JSON */
    #jsonPreview {
      background: #1e1e1e;
      color: #00ffae;
      padding: 15px;
      border-radius: 10px;
      margin-top: 25px;
      white-space: pre-wrap;
      overflow-x: auto;
      font-family: monospace;
      direction: ltr;
    }
  </style>
</head>
<body>

<h1>🎛️ لوحة التحكم في الفيديوهات</h1>

<div class="form">
  <label>العنوان:</label>
  <input type="text" id="title">

  <label>الوصف:</label>
  <textarea id="description"></textarea>

  <label>رابط YouTube:</label>
  <input type="text" id="url" placeholder="https://www.youtube.com/watch?v=XXXXXXX">

  <label>القسم:</label>
  <select id="type">
    <option value="">اختر القسم</option>
    <option value="ماث 0">🧮 ماث 0</option>
    <option value="ماث 1">🧮 ماث 1</option>
    <option value="انجليزي">🇬🇧 إنجليزي</option>
    <option value="دوائر كهربائية">🔌 دوائر كهربائية</option>
    <option value="اخلاقيات المهنه">⚖️ أخلاقيات المهنة</option>
    <option value="مقدمة حاسب الي">💻 مقدمة حاسب آلي</option>
    <option value="فيزياء">🧲 فيزياء</option>
    <option value="كورسات اخرى">🧠 كورسات أخرى</option>
  </select>

  <button id="addBtn">➕ إضافة للفهرس</button>
</div>

<div class="actions">
  <button id="downloadJsonBtn">💾 تحميل JSON</button>
  <button id="uploadFirebaseBtn">📤 رفع إلى Firebase</button>
</div>

<h2 style="color:white;">📚 الأقسام</h2>
<div id="sections-container" class="sections"></div>

<div id="videos-container" class="videos-list"></div>

<h2 style="color:white;">📜 معاينة JSON</h2>
<pre id="jsonPreview">{}</pre>

<script type="module">
  import { db } from './chat/js/fb.js';
  import { ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const titleInput = document.getElementById('title');
  const descInput = document.getElementById('description');
  const urlInput = document.getElementById('url');
  const typeSelect = document.getElementById('type');
  const addBtn = document.getElementById('addBtn');
  const downloadBtn = document.getElementById('downloadJsonBtn');
  const uploadBtn = document.getElementById('uploadFirebaseBtn');
  const sectionsContainer = document.getElementById('sections-container');
  const videosContainer = document.getElementById('videos-container');
  const jsonPreview = document.getElementById('jsonPreview');

  const jsonData = {};

  const sections = [
    "ماث 0","ماث 1","انجليزي","دوائر كهربائية","اخلاقيات المهنه","مقدمة حاسب الي","فيزياء","كورسات اخرى"
  ];

  // 🟢 إنشاء أقسام فارغة في JSON + البطاقات
  sections.forEach(type => {
    jsonData[type] = {};
    const card = document.createElement('div');
    card.className = 'section-card';
    card.textContent = type;
    card.addEventListener('click', () => showSection(type));
    sectionsContainer.appendChild(card);
  });

  addBtn.addEventListener('click', (e) => {
    e.preventDefault();

    const title = titleInput.value.trim();
    const description = descInput.value.trim();
    const url = convertUrl(urlInput.value.trim());
    const type = typeSelect.value;

    if (!title || !description || !url || !type) {
      alert('⚠️ يرجى ملء جميع الحقول');
      return;
    }

    const id = Date.now().toString();
    jsonData[type][id] = { title, description, url, type, id };

    clearForm();
    alert(`✅ تمت إضافة الفيديو إلى قسم ${type}`);
    showSection(type);
    updateJsonPreview(); // تحديث المعاينة
  });

  function convertUrl(link) {
    const match = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{7,})/);
    return match ? `https://www.youtube.com/embed/${match[1]}` : '';
  }

  function clearForm() {
    titleInput.value = '';
    descInput.value = '';
    urlInput.value = '';
    typeSelect.value = '';
  }

  function showSection(type) {
    videosContainer.innerHTML = '';
    const section = jsonData[type];

    if (!section || Object.keys(section).length === 0) {
      videosContainer.innerHTML = '<p style="color:white;">🚧 لا توجد فيديوهات مضافة</p>';
      return;
    }

    Object.values(section).forEach(video => {
      const div = document.createElement('div');
      div.className = 'video-item';
      div.innerHTML = `
        <iframe src="${video.url}" allowfullscreen></iframe>
        <h3>${video.title}</h3>
        <p>${video.description}</p>
      `;
      videosContainer.appendChild(div);
    });
  }

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify({ courses: flattenData(jsonData) }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'courses.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  uploadBtn.addEventListener('click', async () => {
    try {
      await set(ref(db, 'courses'), flattenData(jsonData));
      alert('📤 تم رفع JSON إلى Firebase بنجاح');
    } catch (err) {
      console.error(err);
      alert('❌ حدث خطأ أثناء الرفع');
    }
  });

  function flattenData(data) {
    const result = {};
    for (const section in data) {
      for (const id in data[section]) {
        result[id] = data[section][id];
      }
    }
    return result;
  }

  // 📜 تحديث معاينة JSON في الصفحة
  function updateJsonPreview() {
    jsonPreview.textContent = JSON.stringify({ courses: flattenData(jsonData) }, null, 2);
  }
</script>

</body>
</html>
