<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>لوحة الرئيس 👑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/owner-chat.css">
</head>
<body>
  <header class="top-bar">
    <div class="profile">
      <img id="ownerAvatar" src="" alt="avatar">
      <span id="ownerName">الرئيس</span>
    </div>
    <div class="controls">
      <button id="toggleChatBtn" class="btn danger">🔒 إغلاق الدردشة</button>
      <button id="clearAllBtn" class="btn danger">🗑️ مسح الكل</button>
      <button id="logoutBtn" class="btn">🚪 خروج</button>
    </div>
  </header>

  <main id="chatContainer" class="chat-container"></main>

  <script type="module" src="js/fb.js"></script>
  <script type="module">
    import { db } from './js/fb.js';
    import { ref as dbRef, onChildAdded, onChildRemoved, remove, update, set, get } 
      from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const chatContainer = document.getElementById('chatContainer');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const ownerAvatar = document.getElementById('ownerAvatar');
    const ownerName = document.getElementById('ownerName');

    let chatOpen = true;
    const session = JSON.parse(localStorage.getItem('chat_session') || '{}');
    if (!session || session.role !== 'رئيس') {
      alert('ليس لديك صلاحية الدخول');
      window.location.href = 'index.html';
    }

    ownerAvatar.src = session.avatarUrl || 'icon.png';
    ownerName.textContent = `${session.name} 👑`;

    // 🔄 مراقبة حالة الدردشة
    const chatStatusRef = dbRef(db, 'chat_status');
    async function loadChatStatus() {
      const snap = await get(chatStatusRef);
      if (snap.exists()) {
        chatOpen = snap.val().open;
        updateChatButton();
      } else {
        await set(chatStatusRef, { open: true });
      }
    }
    loadChatStatus();

    function updateChatButton() {
      toggleChatBtn.textContent = chatOpen ? '🔒 إغلاق الدردشة' : '🔓 فتح الدردشة';
      toggleChatBtn.classList.toggle('danger', chatOpen);
      toggleChatBtn.classList.toggle('success', !chatOpen);
    }

    toggleChatBtn.addEventListener('click', async () => {
      chatOpen = !chatOpen;
      await set(chatStatusRef, { open: chatOpen });
      updateChatButton();
      alert(chatOpen ? '✅ تم فتح الدردشة' : '⛔ تم إغلاق الدردشة مؤقتًا');
    });

    // 🚪 خروج
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('chat_session');
      window.location.href = 'owner.html';
    });

    // 💬 تحميل الرسائل
    const messagesRef = dbRef(db, 'messages');
    onChildAdded(messagesRef, (snap) => {
      const msg = snap.val();
      addMessage(snap.key, msg);
    });

    onChildRemoved(messagesRef, (snap) => {
      const el = document.getElementById(`msg-${snap.key}`);
      if (el) el.remove();
    });

    function addMessage(id, msg) {
      const div = document.createElement('div');
      div.className = 'message';
      div.id = `msg-${id}`;
      div.innerHTML = `
        <img src="${msg.avatar}" class="avatar">
        <div class="content">
          <div class="meta">
            <strong>${msg.name}</strong> <span class="role">${msg.role}</span>
          </div>
          <div class="text">${msg.text}</div>
          <div class="actions">
            <button onclick="deleteMessage('${id}')">🗑️ حذف</button>
            <button onclick="banUser('${msg.deviceId || ''}', '${msg.name}')">🚫 حظر</button>
          </div>
        </div>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 🗑️ حذف رسالة واحدة
    window.deleteMessage = async function(id) {
      if (confirm('هل تريد حذف هذه الرسالة؟')) {
        await remove(dbRef(db, `messages/${id}`));
      }
    };

    // 🚫 حظر مستخدم
    window.banUser = async function(deviceId, userName) {
      if (!deviceId) return alert('لا يمكن حظر هذا المستخدم (بدون معرف)');
      if (confirm(`هل تريد حظر ${userName}؟`)) {
        await set(dbRef(db, `bans/${deviceId}`), {
          name: userName,
          timestamp: Date.now()
        });
        alert(`${userName} تم حظره ✅`);
      }
    };

    // 🧹 حذف كل الرسائل دفعة واحدة
    clearAllBtn.addEventListener('click', async () => {
      if (confirm('⚠️ هل أنت متأكد أنك تريد حذف جميع الرسائل؟')) {
        await set(messagesRef, null);
        alert('✅ تم حذف جميع الرسائل بنجاح');
      }
    });
  </script>
</body>
</html>
