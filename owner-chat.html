<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>لوحة الرئيس 👑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/owner-chat.css">
</head>
<body>
  <header class="top-bar">
    <div class="profile">
      <img id="ownerAvatar" src="" alt="avatar">
      <span id="ownerName">الرئيس</span>
    </div>
    <div class="controls">
      <button id="toggleChatBtn" class="btn danger">🔒 إغلاق الدردشة</button>
      <button id="clearAllBtn" class="btn danger">🗑️ مسح الكل</button>
      <button id="logoutBtn" class="btn">🚪 خروج</button>
    </div>
  </header>

  <main class="chat-container">
    <div id="chatContainer" class="messages"></div>
    <div class="composer">
      <input id="msgText" type="text" placeholder="اكتب رسالة هنا...">
      <button id="sendBtn" class="btn">إرسال</button>
    </div>
  </main>

  <!-- ✅ كود Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onChildAdded, onChildRemoved, remove, set, get, push } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzokitueX9Ph_LNUekRpG0MZxpPkgcEiQ",
      authDomain: "hacker-withdraw-photos.firebaseapp.com",
      databaseURL: "https://hacker-withdraw-photos-default-rtdb.firebaseio.com",
      projectId: "hacker-withdraw-photos",
      storageBucket: "hacker-withdraw-photos.appspot.com",
      messagingSenderId: "295892241734",
      appId: "1:295892241734:web:01b7841226bc8b189b2947",
      measurementId: "G-QE2VCZY3NX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // عناصر الصفحة
    const chatContainer = document.getElementById('chatContainer');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const ownerAvatar = document.getElementById('ownerAvatar');
    const ownerName = document.getElementById('ownerName');
    const sendBtn = document.getElementById('sendBtn');
    const msgText = document.getElementById('msgText');

    let chatOpen = true;
    const session = JSON.parse(localStorage.getItem('chat_session') || '{}');
    if (!session || session.role !== 'رئيس') {
      alert('ليس لديك صلاحية الدخول');
      window.location.href = 'index.html';
    }

    ownerAvatar.src = session.avatarUrl || 'icon.png';
    ownerName.textContent = `${session.name} 👑`;

    // ✅ مراقبة حالة الدردشة (فتح/إغلاق)
    const chatStatusRef = dbRef(db, 'chat_status');
    async function loadChatStatus() {
      const snap = await get(chatStatusRef);
      if (snap.exists()) {
        chatOpen = snap.val().open;
        updateChatButton();
      } else {
        await set(chatStatusRef, { open: true });
      }
    }
    loadChatStatus();

    function updateChatButton() {
      toggleChatBtn.textContent = chatOpen ? '🔒 إغلاق الدردشة' : '🔓 فتح الدردشة';
      toggleChatBtn.classList.toggle('danger', chatOpen);
      toggleChatBtn.classList.toggle('success', !chatOpen);
    }

    toggleChatBtn.addEventListener('click', async () => {
      chatOpen = !chatOpen;
      await set(chatStatusRef, { open: chatOpen });
      updateChatButton();
      alert(chatOpen ? '✅ تم فتح الدردشة' : '⛔ تم إغلاق الدردشة مؤقتًا');
    });

    // 🚪 تسجيل الخروج
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('chat_session');
      window.location.href = 'owner.html';
    });

    // 💬 إرسال الرسائل (كرئيس)
    sendBtn.addEventListener('click', async () => {
      if (!chatOpen) return alert('❌ الدردشة مغلقة مؤقتًا');
      const text = msgText.value.trim();
      if (!text) return;

      const mRef = push(dbRef(db, 'messages'));
      await set(mRef, {
        type: 'msg',
        name: session.name,
        avatar: session.avatarUrl || '',
        role: 'رئيس',
        deviceId: 'owner_device',
        text,
        timestamp: Date.now()
      });
      msgText.value = '';
    });

    msgText.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // 📥 استقبال الرسائل
    const messagesRef = dbRef(db, 'messages');
    onChildAdded(messagesRef, (snap) => {
      const msg = snap.val();
      addMessage(snap.key, msg);
    });

    onChildRemoved(messagesRef, (snap) => {
      const el = document.getElementById(`msg-${snap.key}`);
      if (el) el.remove();
    });

    // 🧩 عرض الرسائل
    function addMessage(id, msg) {
      const div = document.createElement('div');
      div.className = 'message';
      div.id = `msg-${id}`;
      div.innerHTML = `
        <img src="${msg.avatar}" class="avatar">
        <div class="content">
          <div class="meta">
            <strong>${msg.name}</strong> <span class="role">${msg.role}</span>
          </div>
          <div class="text">${msg.text}</div>
          <div class="actions">
            <button onclick="deleteMessage('${id}')">🗑️ حذف</button>
            <button onclick="banUser('${msg.deviceId || ''}', '${msg.name}')">🚫 حظر</button>
          </div>
        </div>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 🗑️ حذف رسالة واحدة
    window.deleteMessage = async function(id) {
      if (confirm('هل تريد حذف هذه الرسالة؟')) {
        await remove(dbRef(db, `messages/${id}`));
      }
    };

    // 🚫 حظر مستخدم
    window.banUser = async function(deviceId, userName) {
      if (!deviceId || deviceId === 'owner_device') return alert('لا يمكن حظر الرئيس!');
      if (confirm(`هل تريد حظر ${userName}؟`)) {
        await set(dbRef(db, `bans/${deviceId}`), {
          name: userName,
          timestamp: Date.now()
        });
        alert(`${userName} تم حظره ✅`);
      }
    };

    // 🧹 حذف كل الرسائل
    clearAllBtn.addEventListener('click', async () => {
      if (confirm('⚠️ هل أنت متأكد أنك تريد حذف جميع الرسائل؟')) {
        await set(messagesRef, null);
        alert('✅ تم حذف جميع الرسائل بنجاح');
      }
    });
  </script>
</body>
</html>
