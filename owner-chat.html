<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ ğŸ‘‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style/owner-chat.css">
</head>
<body>
  <header class="top-bar">
    <div class="profile">
      <img id="ownerAvatar" src="" alt="avatar">
      <span id="ownerName">Ø§Ù„Ø±Ø¦ÙŠØ³</span>
    </div>
    <div class="controls">
      <button id="toggleChatBtn" class="btn danger">ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
      <button id="clearAllBtn" class="btn danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      <button id="logoutBtn" class="btn">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="chat-container">
    <div id="chatContainer" class="messages"></div>
    <div class="composer">
      <input id="msgText" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§...">
      <button id="sendBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </main>

  <!-- âœ… ÙƒÙˆØ¯ Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onChildAdded, onChildRemoved, remove, set, get, push } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzokitueX9Ph_LNUekRpG0MZxpPkgcEiQ",
      authDomain: "hacker-withdraw-photos.firebaseapp.com",
      databaseURL: "https://hacker-withdraw-photos-default-rtdb.firebaseio.com",
      projectId: "hacker-withdraw-photos",
      storageBucket: "hacker-withdraw-photos.appspot.com",
      messagingSenderId: "295892241734",
      appId: "1:295892241734:web:01b7841226bc8b189b2947",
      measurementId: "G-QE2VCZY3NX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    const chatContainer = document.getElementById('chatContainer');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const ownerAvatar = document.getElementById('ownerAvatar');
    const ownerName = document.getElementById('ownerName');
    const sendBtn = document.getElementById('sendBtn');
    const msgText = document.getElementById('msgText');

    let chatOpen = true;
    const session = JSON.parse(localStorage.getItem('chat_session') || '{}');
    if (!session || session.role !== 'Ø±Ø¦ÙŠØ³') {
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.href = 'index.html';
    }

    ownerAvatar.src = session.avatarUrl || 'icon.png';
    ownerName.textContent = `${session.name} ğŸ‘‘`;

    // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚)
    const chatStatusRef = dbRef(db, 'chat_status');
    async function loadChatStatus() {
      const snap = await get(chatStatusRef);
      if (snap.exists()) {
        chatOpen = snap.val().open;
        updateChatButton();
      } else {
        await set(chatStatusRef, { open: true });
      }
    }
    loadChatStatus();

    function updateChatButton() {
      toggleChatBtn.textContent = chatOpen ? 'ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'ğŸ”“ ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©';
      toggleChatBtn.classList.toggle('danger', chatOpen);
      toggleChatBtn.classList.toggle('success', !chatOpen);
    }

    toggleChatBtn.addEventListener('click', async () => {
      chatOpen = !chatOpen;
      await set(chatStatusRef, { open: chatOpen });
      updateChatButton();
      alert(chatOpen ? 'âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'â›” ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§');
    });

    // ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('chat_session');
      window.location.href = 'owner.html';
    });

    // ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙƒØ±Ø¦ÙŠØ³)
    sendBtn.addEventListener('click', async () => {
      if (!chatOpen) return alert('âŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§');
      const text = msgText.value.trim();
      if (!text) return;

      const mRef = push(dbRef(db, 'messages'));
      await set(mRef, {
        type: 'msg',
        name: session.name,
        avatar: session.avatarUrl || '',
        role: 'Ø±Ø¦ÙŠØ³',
        deviceId: 'owner_device',
        text,
        timestamp: Date.now()
      });
      msgText.value = '';
    });

    msgText.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const messagesRef = dbRef(db, 'messages');
    onChildAdded(messagesRef, (snap) => {
      const msg = snap.val();
      addMessage(snap.key, msg);
    });

    onChildRemoved(messagesRef, (snap) => {
      const el = document.getElementById(`msg-${snap.key}`);
      if (el) el.remove();
    });

    // ğŸ§© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function addMessage(id, msg) {
      const div = document.createElement('div');
      div.className = 'message';
      div.id = `msg-${id}`;
      div.innerHTML = `
        <img src="${msg.avatar}" class="avatar">
        <div class="content">
          <div class="meta">
            <strong>${msg.name}</strong> <span class="role">${msg.role}</span>
          </div>
          <div class="text">${msg.text}</div>
          <div class="actions">
            <button onclick="deleteMessage('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button onclick="banUser('${msg.deviceId || ''}', '${msg.name}')">ğŸš« Ø­Ø¸Ø±</button>
          </div>
        </div>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ğŸ—‘ï¸ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
    window.deleteMessage = async function(id) {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
        await remove(dbRef(db, `messages/${id}`));
      }
    };

    // ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…
    window.banUser = async function(deviceId, userName) {
      if (!deviceId || deviceId === 'owner_device') return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø¸Ø± Ø§Ù„Ø±Ø¦ÙŠØ³!');
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± ${userName}ØŸ`)) {
        await set(dbRef(db, `bans/${deviceId}`), {
          name: userName,
          timestamp: Date.now()
        });
        alert(`${userName} ØªÙ… Ø­Ø¸Ø±Ù‡ âœ…`);
      }
    };

    // ğŸ§¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    clearAllBtn.addEventListener('click', async () => {
      if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) {
        await set(messagesRef, null);
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    });
  </script>
</body>
</html>
